Bootstrap: docker
From: ubuntu:22.04

%labels
    Author "Jacob Murel"
    Version "1.0.1-mac"
    Name "Princeton Logion (Mac/ARM64 build)"
    Description "Machine learning for Greek philology (Open OnDemand)"
    Copyright "Â© 2025 Jacob Murel and The Trustees of Princeton University"
    URL "https://www.logionproject.princeton.edu/"
    BuildOS
    BuildArchitecture
    BuildDate

%environment
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    export PATH="/opt/logion/bin:$PATH"
    export STATIC_DIR="/logion-app-ondemand/frontend/build"
    export LOGION_RESOURCES_CONFIG="/resources/resources_config.yaml"
    export PYTHONUNBUFFERED=1

%setup
    mkdir -p ${APPTAINER_ROOTFS}/logion-app-ondemand
    cp -r ./src/resources ${APPTAINER_ROOTFS}
    cp -r ./src/backend ${APPTAINER_ROOTFS}/logion-app-ondemand/
    cp -r ./src/frontend ${APPTAINER_ROOTFS}/logion-app-ondemand/
    cp ./requirements.txt ${APPTAINER_ROOTFS}/logion-app-ondemand/backend

%post
    export DEBIAN_FRONTEND=noninteractive
    echo "Installing system dependencies for ARM64"
    apt-get update
    
    # install build-essential for C compiler (gcc) and python3.10-dev for Python headers
    # required to compile Python packages from src
    apt-get install -y --no-install-recommends \
        build-essential \
        python3.10-dev \
        curl \
        nodejs \
        python3.10 \
        python3.10-venv \
        git

    # Install Node.js v20.x
    curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
    apt-get install -y --no-install-recommends nodejs

    echo "Building frontend application"
    cd /logion-app-ondemand/frontend
    npm install --no-optional
    npm run build

    echo "Prepare backend environment"
    python3.10 -m venv /opt/logion
    /opt/logion/bin/pip install --no-cache-dir --upgrade pip
    /opt/logion/bin/pip install --no-cache-dir -r /logion-app-ondemand/backend/requirements.txt 


    echo "Clean up build dependencies"
    apt-get purge -y --auto-remove build-essential python3.10-dev
    apt-get clean
    rm -rf /var/lib/apt/lists/*
    rm -rf /root/.cache/npm

%runscript

    cd /logion-app-ondemand/backend

    echo "--- Logion App Container ---"
    echo "Spawning Logion server at http://${LOGION_HOST}:${LOGION_PORT}"
    echo "GPU available: $(/opt/logion/bin/python -c 'import torch; print(torch.cuda.is_available())')"
    echo "Static served from ${STATIC_DIR}"
    
    #exec uvicorn main:app
    exec /opt/logion/bin/uvicorn main:app --host "$LOGION_HOST" --port "$LOGION_PORT" "$@"

%startscript
    # script executed with `apptainer instance start my_app.sif my_instance`    
    cd /logion-app-ondemand/backend

    echo "--- Logion App Container Instance ---"
    echo "Spawning Logion server at http://${LOGION_HOST}:${LOGION_PORT}"
    echo "GPU available: $(/opt/logion/bin/python -c 'import torch; print(torch.cuda.is_available())')"
    echo "Static served from ${STATIC_DIR}"
    
    #exec uvicorn main:app
    exec /opt/logion/bin/uvicorn main:app --host "$LOGION_HOST" --port "$LOGION_PORT" "$@"